var convnetjs=convnetjs||{REVISION:"ALPHA"};(function(c){var h=false;var d=0;var i=function(){if(h){h=false;return d}var k=2*Math.random()-1;var j=2*Math.random()-1;var l=k*k+j*j;if(l==0||l>1){return i()}var m=Math.sqrt(-2*Math.log(l)/l);d=j*m;h=true;return k*m};var g=function(k,j){return Math.random()*(j-k)+k};var f=function(k,j){return Math.floor(Math.random()*(j-k)+k)};var b=function(k,j){return k+i()*j};var e=function(l){if(typeof(l)==="undefined"||isNaN(l)){return[]}if(typeof ArrayBuffer==="undefined"){var j=new Array(l);for(var k=0;k<l;k++){j[k]=0}return j}else{return new Float64Array(l)}};var a=function(k){if(k.length===0){return{}}var j=k[0];var m=k[0];var l=0;var p=0;var q=k.length;for(var o=1;o<q;o++){if(k[o]>j){j=k[o];l=o}if(k[o]<m){m=k[o];p=o}}return{maxi:l,maxv:j,mini:p,minv:m,dv:j-m}};c.randf=g;c.randi=f;c.randn=b;c.zeros=e;c.maxmin=a})(convnetjs);(function(b){var a=function(k,g,f,j){this.sx=k;this.sy=g;this.depth=f;var h=k*g*f;this.w=b.zeros(h);this.dw=b.zeros(h);if(typeof j==="undefined"){var e=Math.sqrt(1/(k*g*f));for(var d=0;d<h;d++){this.w[d]=b.randn(0,e)}}else{for(var d=0;d<h;d++){this.w[d]=j}}};a.prototype={get:function(c,g,f){var e=((this.sx*g)+c)*this.depth+f;return this.w[e]},set:function(c,h,g,f){var e=((this.sx*h)+c)*this.depth+g;this.w[e]=f},add:function(c,g,f,e){this.w[((this.sx*g)+c)*this.depth+f]+=e},get_grad:function(c,f,e){return this.dw[((this.sx*f)+c)*this.depth+e]},set_grad:function(c,g,f,e){this.dw[((this.sx*g)+c)*this.depth+f]=e},add_grad:function(c,g,f,e){this.dw[((this.sx*g)+c)*this.depth+f]+=e},cloneAndZero:function(){return new a(this.sx,this.sy,this.depth,0)},clone:function(){var c=new a(this.sx,this.sy,this.depth,0);var e=this.w.length;for(var d=0;d<e;d++){c.w[d]=this.w[d]}return c},addFrom:function(c){for(var d=0;d<this.w.length;d++){this.w[d]+=c.w[d]}},addFromScaled:function(d,c){for(var e=0;e<this.w.length;e++){this.w[e]+=c*d.w[e]}},setConst:function(c){for(var d=0;d<this.w.length;d++){this.w[d]=c}},toJSON:function(){var c={};c.sx=this.sx;c.sy=this.sy;c.depth=this.depth;c.w=this.w;return c},fromJSON:function(c){this.sx=c.sx;this.sy=c.sy;this.depth=c.depth;this.w=c.w;this.dw=b.zeros(this.w.length)}};b.Vol=a})(convnetjs);(function(c){var a=c.Vol;var b=function(f,h,n,m,g){if(typeof(g)==="undefined"){var g=false}if(typeof(n)==="undefined"){var n=c.randi(0,f.sx-h)}if(typeof(m)==="undefined"){var m=c.randi(0,f.sy-h)}var e;if(h!==f.sx||n!==0||m!==0){e=new a(h,h,f.depth,0);for(var l=0;l<h;l++){for(var k=0;k<h;k++){if(l+n<0||l+n>=f.sx||k+m<0||k+m>=f.sy){continue}for(var j=0;j<f.depth;j++){e.set(l,k,j,f.get(l+n,k+m,j))}}}}else{e=f}if(g){var i=e.cloneAndZero();for(var l=0;l<e.sx;l++){for(var k=0;k<e.sy;k++){for(var j=0;j<e.depth;j++){i.set(l,k,j,e.get(e.sx-l-1,k,j))}}}e=i}return e};var d=function(o,n){if(typeof(n)==="undefined"){var n=false}var h=document.createElement("canvas");h.width=o.width;h.height=o.height;var u=h.getContext("2d");try{u.drawImage(o,0,0)}catch(q){if(q.name==="NS_ERROR_NOT_AVAILABLE"){return false}else{throw q}}try{var v=u.getImageData(0,0,h.width,h.height)}catch(q){if(q.name==="IndexSizeError"){return false}else{throw q}}var g=v.data;var k=o.width;var s=o.height;var t=[];for(var m=0;m<g.length;m++){t.push(g[m]/255-0.5)}var r=new a(k,s,4,0);r.w=t;if(n){var f=new a(k,s,1,0);for(var m=0;m<k;m++){for(var l=0;l<s;l++){f.set(m,l,0,r.get(m,l,0))}}r=f}return r};c.augment=b;c.img_to_vol=d})(convnetjs);(function(d){var b=d.Vol;var e=function(g){var g=g||{};this.out_depth=g.filters;this.sx=g.sx;this.in_depth=g.in_depth;this.in_sx=g.in_sx;this.in_sy=g.in_sy;this.sy=typeof g.sy!=="undefined"?g.sy:this.sx;this.stride=typeof g.sy!=="undefined"?g.stride:1;this.l1_decay_mul=typeof g.l1_decay_mul!=="undefined"?g.l1_decay_mul:0;this.l2_decay_mul=typeof g.l2_decay_mul!=="undefined"?g.l2_decay_mul:1;this.out_sx=Math.floor(this.in_sx/this.stride);this.out_sy=Math.floor(this.in_sy/this.stride);this.layer_type="conv";this.filters=[];for(var f=0;f<this.out_depth;f++){this.filters.push(new b(this.sx,this.sy,this.in_depth))}this.biases=new b(1,1,this.out_depth,0.1)};e.prototype={forward:function(m,v){this.in_act=m;var k=new b(this.out_sx,this.out_sy,this.out_depth,0);var q=Math.floor(this.sx/2);var o=Math.floor(this.sy/2);for(var r=0;r<this.out_depth;r++){var p=this.filters[r];var g=0;var w=0;for(var u=0;u<m.sx;u+=this.stride,g++){w=0;for(var s=0;s<m.sy;s+=this.stride,w++){var t=0;for(var n=0;n<p.sx;n++){for(var l=0;l<p.sy;l++){for(var j=0;j<p.depth;j++){var h=s+l-o;var i=u+n-q;if(h>=0&&h<m.sy&&i>=0&&i<m.sx){t+=p.w[((p.sx*l)+n)*p.depth+j]*m.w[((m.sx*h)+i)*m.depth+j]}}}}t+=this.biases.w[r];k.set(g,w,r,t)}}}this.out_act=k;return this.out_act},backward:function(){var l=this.in_act;l.dw=d.zeros(l.w.length);var p=Math.floor(this.sx/2);var n=Math.floor(this.sy/2);for(var r=0;r<this.out_depth;r++){var o=this.filters[r];var g=0;var u=0;for(var t=0;t<l.sx;t+=this.stride,g++){u=0;for(var s=0;s<l.sy;s+=this.stride,u++){var q=this.out_act.get_grad(g,u,r);for(var m=0;m<o.sx;m++){for(var k=0;k<o.sy;k++){for(var j=0;j<o.depth;j++){var h=s+k-n;var i=t+m-p;if(h>=0&&h<l.sy&&i>=0&&i<l.sx){o.dw[((o.sx*k)+m)*o.depth+j]+=l.w[((l.sx*h)+i)*l.depth+j]*q;l.dw[((l.sx*h)+i)*l.depth+j]+=o.w[((o.sx*k)+m)*o.depth+j]*q}}}}this.biases.dw[r]+=q}}}},getParamsAndGrads:function(){var f=[];for(var g=0;g<this.out_depth;g++){f.push({params:this.filters[g].w,grads:this.filters[g].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul})}f.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return f},toJSON:function(){var g={};g.sx=this.sx;g.sy=this.sy;g.stride=this.stride;g.in_depth=this.in_depth;g.out_depth=this.out_depth;g.out_sx=this.out_sx;g.out_sy=this.out_sy;g.layer_type=this.layer_type;g.l1_decay_mul=this.l1_decay_mul;g.l2_decay_mul=this.l2_decay_mul;g.filters=[];for(var f=0;f<this.filters.length;f++){g.filters.push(this.filters[f].toJSON())}g.biases=this.biases.toJSON();return g},fromJSON:function(h){this.out_depth=h.out_depth;this.out_sx=h.out_sx;this.out_sy=h.out_sy;this.layer_type=h.layer_type;this.sx=h.sx;this.sy=h.sy;this.stride=h.stride;this.in_depth=h.in_depth;this.filters=[];this.l1_decay_mul=typeof h.l1_decay_mul!=="undefined"?h.l1_decay_mul:1;this.l2_decay_mul=typeof h.l2_decay_mul!=="undefined"?h.l2_decay_mul:1;for(var g=0;g<h.filters.length;g++){var f=new b(0,0,0,0);f.fromJSON(h.filters[g]);this.filters.push(f)}this.biases=new b(0,0,0,0);this.biases.fromJSON(h.biases)}};var a=function(g){var g=g||{};this.out_depth=g.filters;this.sx=g.sx;this.in_depth=g.in_depth;this.in_sx=g.in_sx;this.in_sy=g.in_sy;this.sy=typeof g.sy!=="undefined"?g.sy:this.sx;this.stride=typeof g.sy!=="undefined"?g.stride:1;this.l1_decay_mul=typeof g.l1_decay_mul!=="undefined"?g.l1_decay_mul:0;this.l2_decay_mul=typeof g.l2_decay_mul!=="undefined"?g.l2_decay_mul:1;this.out_sx=Math.floor(this.in_sx/this.stride);this.out_sy=Math.floor(this.in_sy/this.stride);this.layer_type="local";this.filters=[];var h=this.out_sx*this.out_sy*this.out_depth;for(var f=0;f<h;f++){this.filters.push(new b(this.sx,this.sy,this.in_depth))}this.biases=new b(1,1,h,0.1)};a.prototype={forward:function(i,l){this.in_act=i;var s=new b(this.out_sx,this.out_sy,this.out_depth,0);var w=Math.floor(this.sx/2);var u=Math.floor(this.sy/2);var t=0;for(var z=0;z<this.out_depth;z++){var q=0;var o=0;for(var p=0;p<i.sx;p+=this.stride,q++){o=0;for(var m=0;m<i.sy;m+=this.stride,o++){var v=this.filters[t];var B=0;for(var h=0;h<v.sx;h++){for(var g=0;g<v.sy;g++){for(var r=0;r<v.depth;r++){var j=m+g-u;var k=p+h-w;if(j>=0&&j<i.sy&&k>=0&&k<i.sx){B+=v.w[((v.sx*g)+h)*v.depth+r]*i.w[((i.sx*j)+k)*i.depth+r]}}}}B+=this.biases.w[t];s.set(q,o,z,B);t++}}}this.out_act=s;return this.out_act},backward:function(){var m=this.in_act;m.dw=d.zeros(m.w.length);var r=Math.floor(this.sx/2);var q=Math.floor(this.sy/2);var k=0;for(var t=0;t<this.out_depth;t++){var g=0;var w=0;for(var v=0;v<m.sx;v+=this.stride,g++){w=0;for(var u=0;u<m.sy;u+=this.stride,w++){var p=this.filters[k];var s=this.out_act.get_grad(g,w,t);for(var o=0;o<p.sx;o++){for(var l=0;l<p.sy;l++){for(var j=0;j<p.depth;j++){var h=u+l-q;var i=v+o-r;if(h>=0&&h<m.sy&&i>=0&&i<m.sx){p.dw[((p.sx*l)+o)*p.depth+j]+=m.w[((m.sx*h)+i)*m.depth+j]*s;m.dw[((m.sx*h)+i)*m.depth+j]+=p.w[((p.sx*l)+o)*p.depth+j]*s}}}}this.biases.dw[k]+=s;k++}}}},getParamsAndGrads:function(){var f=[];for(var g=0;g<this.filters.length;g++){f.push({params:this.filters[g].w,grads:this.filters[g].dw,l2_decay_mul:this.l2_decay_mul,l1_decay_mul:this.l1_decay_mul})}f.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return f},toJSON:function(){var g={};g.sx=this.sx;g.sy=this.sy;g.stride=this.stride;g.in_depth=this.in_depth;g.out_depth=this.out_depth;g.out_sx=this.out_sx;g.out_sy=this.out_sy;g.layer_type=this.layer_type;g.l1_decay_mul=this.l1_decay_mul;g.l2_decay_mul=this.l2_decay_mul;g.filters=[];for(var f=0;f<this.filters.length;f++){g.filters.push(this.filters[f].toJSON())}g.biases=this.biases.toJSON();return g},fromJSON:function(h){this.out_depth=h.out_depth;this.out_sx=h.out_sx;this.out_sy=h.out_sy;this.layer_type=h.layer_type;this.sx=h.sx;this.sy=h.sy;this.stride=h.stride;this.in_depth=h.in_depth;this.filters=[];this.l1_decay_mul=typeof h.l1_decay_mul!=="undefined"?h.l1_decay_mul:1;this.l2_decay_mul=typeof h.l2_decay_mul!=="undefined"?h.l2_decay_mul:1;for(var g=0;g<h.filters.length;g++){var f=new b(0,0,0,0);f.fromJSON(h.filters[g]);this.filters.push(f)}this.biases=new b(0,0,0,0);this.biases.fromJSON(h.biases)}};var c=function(h){var h=h||{};this.out_depth=typeof h.num_neurons!=="undefined"?h.num_neurons:h.filters;this.l1_decay_mul=typeof h.l1_decay_mul!=="undefined"?h.l1_decay_mul:0;this.l2_decay_mul=typeof h.l2_decay_mul!=="undefined"?h.l2_decay_mul:1;this.num_inputs=h.in_sx*h.in_sy*h.in_depth;this.out_sx=1;this.out_sy=1;this.layer_type="fc";var f=typeof h.bias_pref!=="undefined"?h.bias_pref:0.1;this.filters=[];for(var g=0;g<this.out_depth;g++){this.filters.push(new b(1,1,this.num_inputs))}this.biases=new b(1,1,this.out_depth,f)};c.prototype={forward:function(j,m){this.in_act=j;var g=new b(1,1,this.out_depth,0);var l=j.w;for(var k=0;k<this.out_depth;k++){var h=0;var f=this.filters[k].w;for(var n=0;n<this.num_inputs;n++){h+=l[n]*f[n]}h+=this.biases.w[k];g.w[k]=h}this.out_act=g;return this.out_act},backward:function(){var f=this.in_act;f.dw=d.zeros(f.w.length);for(var g=0;g<this.out_depth;g++){var j=this.filters[g];var h=this.out_act.dw[g];for(var k=0;k<this.num_inputs;k++){f.dw[k]+=j.w[k]*h;j.dw[k]+=f.w[k]*h}this.biases.dw[g]+=h}},getParamsAndGrads:function(){var f=[];for(var g=0;g<this.out_depth;g++){f.push({params:this.filters[g].w,grads:this.filters[g].dw,l1_decay_mul:this.l1_decay_mul,l2_decay_mul:this.l2_decay_mul})}f.push({params:this.biases.w,grads:this.biases.dw,l1_decay_mul:0,l2_decay_mul:0});return f},toJSON:function(){var g={};g.out_depth=this.out_depth;g.out_sx=this.out_sx;g.out_sy=this.out_sy;g.layer_type=this.layer_type;g.num_inputs=this.num_inputs;g.l1_decay_mul=this.l1_decay_mul;g.l2_decay_mul=this.l2_decay_mul;g.filters=[];for(var f=0;f<this.filters.length;f++){g.filters.push(this.filters[f].toJSON())}g.biases=this.biases.toJSON();return g},fromJSON:function(h){this.out_depth=h.out_depth;this.out_sx=h.out_sx;this.out_sy=h.out_sy;this.layer_type=h.layer_type;this.num_inputs=h.num_inputs;this.l1_decay_mul=typeof h.l1_decay_mul!=="undefined"?h.l1_decay_mul:1;this.l2_decay_mul=typeof h.l2_decay_mul!=="undefined"?h.l2_decay_mul:1;this.filters=[];for(var g=0;g<h.filters.length;g++){var f=new b(0,0,0,0);f.fromJSON(h.filters[g]);this.filters.push(f)}this.biases=new b(0,0,0,0);this.biases.fromJSON(h.biases)}};d.ConvLayer=e;d.LocallyConnLayer=a;d.FullyConnLayer=c})(convnetjs);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.sx=d.sx;this.in_depth=d.in_depth;this.in_sx=d.in_sx;this.in_sy=d.in_sy;this.sy=typeof d.sy!=="undefined"?d.sy:this.sx;this.stride=typeof d.stride!=="undefined"?d.stride:2;this.out_depth=this.in_depth;this.out_sx=Math.floor(this.in_sx/this.stride);this.out_sy=Math.floor(this.in_sy/this.stride);this.layer_type="pool";this.switchx=c.zeros(this.out_sx*this.out_sy*this.out_depth);this.switchy=c.zeros(this.out_sx*this.out_sy*this.out_depth)};b.prototype={forward:function(g,j){this.in_act=g;var q=new a(this.out_sx,this.out_sy,this.out_depth,0);var w=Math.floor(this.sx/2);var u=Math.floor(this.sy/2);var r=0;for(var z=0;z<this.out_depth;z++){var o=0;var l=0;for(var m=0;m<g.sx;m+=this.stride,o++){l=0;for(var k=0;k<g.sy;k+=this.stride,l++){var B=-99999;var t=-1,s=-1;for(var f=0;f<this.sx;f++){for(var e=0;e<this.sy;e++){var h=k+e-u;var i=m+f-w;if(h>=0&&h<g.sy&&i>=0&&i<g.sx){var p=g.get(i,h,z);if(p>B){B=p;t=i;s=h}}}}this.switchx[r]=t;this.switchy[r]=s;r++;q.set(o,l,z,B)}}}this.out_act=q;return this.out_act},backward:function(){var h=this.in_act;h.dw=c.zeros(h.w.length);var f=this.out_act;var j=Math.floor(this.sx/2);var i=Math.floor(this.sy/2);var g=0;for(var l=0;l<this.out_depth;l++){var e=0;var p=0;for(var o=0;o<h.sx;o+=this.stride,e++){p=0;for(var m=0;m<h.sy;m+=this.stride,p++){var k=this.out_act.get_grad(e,p,l);h.add_grad(this.switchx[g],this.switchy[g],l,k);g++}}}},getParamsAndGrads:function(){return[]},toJSON:function(){var d={};d.sx=this.sx;d.sy=this.sy;d.stride=this.stride;d.in_depth=this.in_depth;d.out_depth=this.out_depth;d.out_sx=this.out_sx;d.out_sy=this.out_sy;d.layer_type=this.layer_type;return d},fromJSON:function(d){this.out_depth=d.out_depth;this.out_sx=d.out_sx;this.out_sy=d.out_sy;this.layer_type=d.layer_type;this.sx=d.sx;this.sy=d.sy;this.stride=d.stride;this.in_depth=d.in_depth}};c.PoolLayer=b})(convnetjs);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.out_sx=typeof d.out_sx!=="undefined"?d.out_sx:d.in_sx;this.out_sy=typeof d.out_sy!=="undefined"?d.out_sy:d.in_sy;this.out_depth=typeof d.out_depth!=="undefined"?d.out_depth:d.in_depth;this.layer_type="input"};b.prototype={forward:function(d,e){this.in_act=d;this.out_act=d;return this.out_act},backward:function(){},getParamsAndGrads:function(){return[]},toJSON:function(){var d={};d.out_depth=this.out_depth;d.out_sx=this.out_sx;d.out_sy=this.out_sy;d.layer_type=this.layer_type;return d},fromJSON:function(d){this.out_depth=d.out_depth;this.out_sx=d.out_sx;this.out_sy=d.out_sy;this.layer_type=d.layer_type}};c.InputLayer=b})(convnetjs);(function(d){var a=d.Vol;var b=function(e){var e=e||{};this.num_inputs=e.in_sx*e.in_sy*e.in_depth;this.out_depth=this.num_inputs;this.out_sx=1;this.out_sy=1;this.layer_type="softmax"};b.prototype={forward:function(h,o){this.in_act=h;var f=new a(1,1,this.out_depth,0);var j=h.w;var k=h.w[0];for(var l=1;l<this.out_depth;l++){if(j[l]>k){k=j[l]}}var n=d.zeros(this.out_depth);var g=0;for(var l=0;l<this.out_depth;l++){var m=Math.exp(j[l]-k);g+=m;n[l]=m}for(var l=0;l<this.out_depth;l++){n[l]/=g;f.w[l]=n[l]}this.es=n;this.out_act=f;return this.out_act},backward:function(j){var e=this.in_act;e.dw=d.zeros(e.w.length);for(var g=0;g<this.out_depth;g++){var f=g===j?1:0;var h=-(f-this.es[g]);e.dw[g]=h}return -Math.log(this.es[j])},getParamsAndGrads:function(){return[]},toJSON:function(){var e={};e.out_depth=this.out_depth;e.out_sx=this.out_sx;e.out_sy=this.out_sy;e.layer_type=this.layer_type;e.num_inputs=this.num_inputs;return e},fromJSON:function(e){this.out_depth=e.out_depth;this.out_sx=e.out_sx;this.out_sy=e.out_sy;this.layer_type=e.layer_type;this.num_inputs=e.num_inputs}};var c=function(e){var e=e||{};this.num_inputs=e.in_sx*e.in_sy*e.in_depth;this.out_depth=this.num_inputs;this.out_sx=1;this.out_sy=1;this.layer_type="regression"};c.prototype={forward:function(e,f){this.in_act=e;this.out_act=e;return e},backward:function(j){var e=this.in_act;e.dw=d.zeros(e.w.length);var h=0;for(var g=0;g<this.out_depth;g++){var f=e.w[g]-j[g];e.dw[g]=f;h+=2*f*f}return h},getParamsAndGrads:function(){return[]},toJSON:function(){var e={};e.out_depth=this.out_depth;e.out_sx=this.out_sx;e.out_sy=this.out_sy;e.layer_type=this.layer_type;e.num_inputs=this.num_inputs;return e},fromJSON:function(e){this.out_depth=e.out_depth;this.out_sx=e.out_sx;this.out_sy=e.out_sy;this.layer_type=e.layer_type;this.num_inputs=e.num_inputs}};d.RegressionLayer=c;d.SoftmaxLayer=b})(convnetjs);(function(b){var a=b.Vol;var c=function(e){var e=e||{};this.out_sx=e.in_sx;this.out_sy=e.in_sy;this.out_depth=e.in_depth;this.layer_type="relu"};c.prototype={forward:function(f,h){this.in_act=f;var e=f.clone();var j=f.w.length;var k=e.w;for(var g=0;g<j;g++){if(k[g]<0){k[g]=0}}this.out_act=e;return this.out_act},backward:function(){var f=this.in_act;var e=this.out_act;var h=f.w.length;f.dw=b.zeros(h);for(var g=0;g<h;g++){if(e.w[g]<=0){f.dw[g]=0}else{f.dw[g]=e.dw[g]}}},getParamsAndGrads:function(){return[]},toJSON:function(){var e={};e.out_depth=this.out_depth;e.out_sx=this.out_sx;e.out_sy=this.out_sy;e.layer_type=this.layer_type;return e},fromJSON:function(e){this.out_depth=e.out_depth;this.out_sx=e.out_sx;this.out_sy=e.out_sy;this.layer_type=e.layer_type}};var d=function(e){var e=e||{};this.out_sx=e.in_sx;this.out_sy=e.in_sy;this.out_depth=e.in_depth;this.layer_type="sigmoid"};d.prototype={forward:function(f,j){this.in_act=f;var e=f.cloneAndZero();var k=f.w.length;var l=e.w;var h=f.w;for(var g=0;g<k;g++){l[g]=1/(1+Math.exp(-h[g]))}this.out_act=e;return this.out_act},backward:function(){var f=this.in_act;var e=this.out_act;var j=f.w.length;f.dw=b.zeros(j);for(var g=0;g<j;g++){var h=e.w[g];f.dw[g]=h*(1-h)*e.dw[g]}},getParamsAndGrads:function(){return[]},toJSON:function(){var e={};e.out_depth=this.out_depth;e.out_sx=this.out_sx;e.out_sy=this.out_sy;e.layer_type=this.layer_type;return e},fromJSON:function(e){this.out_depth=e.out_depth;this.out_sx=e.out_sx;this.out_sy=e.out_sy;this.layer_type=e.layer_type}};b.ReluLayer=c;b.SigmoidLayer=d})(convnetjs);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.out_sx=d.in_sx;this.out_sy=d.in_sy;this.out_depth=d.in_depth;this.layer_type="dropout";this.drop_prob=typeof d.drop_prob!=="undefined"?d.drop_prob:0.5;this.dropped=c.zeros(this.out_sx*this.out_sy*this.out_depth)};b.prototype={forward:function(e,g){this.in_act=e;if(typeof(g)==="undefined"){g=false}var d=e.clone();var h=e.w.length;if(g){for(var f=0;f<h;f++){if(Math.random()<this.drop_prob){d.w[f]=0;this.dropped[f]=true}else{this.dropped[f]=false}}}else{for(var f=0;f<h;f++){d.w[f]*=this.drop_prob}}this.out_act=d;return this.out_act},backward:function(){var d=this.in_act;var f=this.out_act;var g=d.w.length;d.dw=c.zeros(g);for(var e=0;e<g;e++){if(!(this.dropped[e])){d.dw[e]=f.dw[e]}}},getParamsAndGrads:function(){return[]},toJSON:function(){var d={};d.out_depth=this.out_depth;d.out_sx=this.out_sx;d.out_sy=this.out_sy;d.layer_type=this.layer_type;d.drop_prob=this.drop_prob;return d},fromJSON:function(d){this.out_depth=d.out_depth;this.out_sx=d.out_sx;this.out_sy=d.out_sy;this.layer_type=d.layer_type;this.drop_prob=d.drop_prob}};c.DropoutLayer=b})(convnetjs);(function(c){var a=c.Vol;var b=function(d){var d=d||{};this.k=d.k;this.n=d.n;this.alpha=d.alpha;this.beta=d.beta;this.out_sx=d.in_sx;this.out_sy=d.in_sy;this.out_depth=d.in_depth;this.layer_type="lrn";if(this.n%2===0){console.log("WARNING n should be odd for LRN layer")}};b.prototype={forward:function(f,p){this.in_act=f;var e=f.cloneAndZero();this.S_cache_=f.cloneAndZero();var k=Math.floor(this.n/2);for(var n=0;n<f.sx;n++){for(var m=0;m<f.sy;m++){for(var h=0;h<f.depth;h++){var l=f.get(n,m,h);var o=0;for(var g=Math.max(0,h-k);g<=Math.min(h+k,f.depth-1);g++){var d=f.get(n,m,g);o+=d*d}o*=this.alpha/this.n;o+=this.k;this.S_cache_.set(n,m,h,o);o=Math.pow(o,this.beta);e.set(n,m,h,l/o)}}}this.out_act=e;return this.out_act},backward:function(){var f=this.in_act;f.dw=c.zeros(f.w.length);var d=this.out_act;var n=Math.floor(this.n/2);for(var r=0;r<f.sx;r++){for(var q=0;q<f.sy;q++){for(var l=0;l<f.depth;l++){var p=this.out_act.get_grad(r,q,l);var k=this.S_cache_.get(r,q,l);var e=Math.pow(k,this.beta);var s=e*e;for(var h=Math.max(0,l-n);h<=Math.min(l+n,f.depth-1);h++){var o=f.get(r,q,h);var m=-o*this.beta*Math.pow(k,this.beta-1)*this.alpha/this.n*2*o;if(h===l){m+=e}m/=s;m*=p;f.add_grad(r,q,h,m)}}}}},getParamsAndGrads:function(){return[]},toJSON:function(){var d={};d.k=this.k;d.n=this.n;d.alpha=this.alpha;d.beta=this.beta;d.out_sx=this.out_sx;d.out_sy=this.out_sy;d.out_depth=this.out_depth;d.layer_type=this.layer_type;return d},fromJSON:function(d){this.k=d.k;this.n=d.n;this.alpha=d.alpha;this.beta=d.beta;this.out_sx=d.out_sx;this.out_sy=d.out_sy;this.out_depth=d.out_depth;this.layer_type=d.layer_type}};c.LocalResponseNormalizationLayer=b})(convnetjs);(function(c){var a=c.Vol;var b=function(d){this.layers=[]};b.prototype={makeLayers:function(d){if(d.length<2){console.log("ERROR! For now at least have input and softmax layers.")}if(d[0].type!=="input"){console.log("ERROR! For now first layer should be input.")}var e=function(){var k=[];for(var j=0;j<d.length;j++){var l=d[j];if(l.type==="softmax"){k.push({type:"fc",num_neurons:l.num_classes})}if(l.type==="regression"){k.push({type:"fc",num_neurons:l.num_neurons})}if((l.type==="fc"||l.type==="conv"||l.type==="local")&&typeof(l.bias_pref)==="undefined"){l.bias_pref=0;if(typeof l.activation!=="undefined"&&l.activation==="relu"){l.bias_pref=0.1}}k.push(l);if(typeof l.activation!=="undefined"){if(l.activation==="relu"){k.push({type:"relu"})}else{if(l.activation==="sigmoid"){k.push({type:"sigmoid"})}else{console.log("ERROR unsupported activation "+l.activation)}}}if(typeof l.drop_prob!=="undefined"&&l.type!=="dropout"){k.push({type:"dropout",drop_prob:l.drop_prob})}}return k};d=e(d);this.layers=[];for(var f=0;f<d.length;f++){var h=d[f];if(f>0){var g=this.layers[f-1];h.in_sx=g.out_sx;h.in_sy=g.out_sy;h.in_depth=g.out_depth}switch(h.type){case"fc":this.layers.push(new c.FullyConnLayer(h));break;case"lrn":this.layers.push(new c.LocalResponseNormalizationLayer(h));break;case"dropout":this.layers.push(new c.DropoutLayer(h));break;case"input":this.layers.push(new c.InputLayer(h));break;case"softmax":this.layers.push(new c.SoftmaxLayer(h));break;case"regression":this.layers.push(new c.RegressionLayer(h));break;case"conv":this.layers.push(new c.ConvLayer(h));break;case"local":this.layers.push(new c.LocallyConnLayer(h));break;case"pool":this.layers.push(new c.PoolLayer(h));break;case"relu":this.layers.push(new c.ReluLayer(h));break;case"sigmoid":this.layers.push(new c.SigmoidLayer(h));break;default:console.log("ERROR: UNRECOGNIZED LAYER TYPE!")}}},forward:function(e,g){if(typeof(g)==="undefined"){g=false}var d=this.layers[0].forward(e,g);for(var f=1;f<this.layers.length;f++){d=this.layers[f].forward(d,g)}return d},backward:function(g){var f=this.layers.length;var e=this.layers[f-1].backward(g);for(var d=f-2;d>=0;d--){this.layers[d].backward()}return e},getParamsAndGrads:function(){var d=[];for(var f=0;f<this.layers.length;f++){var g=this.layers[f].getParamsAndGrads();for(var e=0;e<g.length;e++){d.push(g[e])}}return d},getPrediction:function(){var g=this.layers[this.layers.length-1];var h=g.out_act.w;var d=h[0];var e=0;for(var f=1;f<h.length;f++){if(h[f]>d){d=h[f];e=f}}return e},toJSON:function(){var e={};e.layers=[];for(var d=0;d<this.layers.length;d++){e.layers.push(this.layers[d].toJSON())}return e},fromJSON:function(h){this.layers=[];for(var g=0;g<h.layers.length;g++){var e=h.layers[g];var f=e.layer_type;var d;if(f==="input"){d=new c.InputLayer()}if(f==="relu"){d=new c.ReluLayer()}if(f==="sigmoid"){d=new c.SigmoidLayer()}if(f==="dropout"){d=new c.DropoutLayer()}if(f==="conv"){d=new c.ConvLayer()}if(f==="local"){d=new c.LocallyConnLayer()}if(f==="pool"){d=new c.PoolLayer()}if(f==="lrn"){d=new c.LocalResponseNormalizationLayer()}if(f==="softmax"){d=new c.SoftmaxLayer()}if(f==="regression"){d=new c.RegressionLayer()}if(f==="fc"){d=new c.FullyConnLayer()}d.fromJSON(e);this.layers.push(d)}}};c.Net=b})(convnetjs);(function(c){var a=c.Vol;var b=function(e,d){this.net=e;var d=d||{};this.learning_rate=typeof d.learning_rate!=="undefined"?d.learning_rate:0.01;this.l1_decay=typeof d.l1_decay!=="undefined"?d.l1_decay:0;this.l2_decay=typeof d.l2_decay!=="undefined"?d.l2_decay:0;this.batch_size=typeof d.batch_size!=="undefined"?d.batch_size:1;this.momentum=typeof d.momentum!=="undefined"?d.momentum:0.9;if(typeof d.momentum!=="undefined"){this.momentum=d.momentum}this.k=0;this.last_gs=[]};b.prototype={train:function(r,q){var h=new Date().getTime();this.net.forward(r,true);var f=new Date().getTime();var o=f-h;var h=new Date().getTime();var w=this.net.backward(q);var k=0;var d=0;var f=new Date().getTime();var E=f-h;this.k++;if(this.k%this.batch_size===0){var e=this.net.getParamsAndGrads();if(this.last_gs.length===0&&this.momentum>0){for(var B=0;B<e.length;B++){this.last_gs.push(c.zeros(e[B].params.length))}}for(var B=0;B<e.length;B++){var F=e[B];var t=F.params;var C=F.grads;var v=typeof F.l2_decay_mul!=="undefined"?F.l2_decay_mul:1;var G=typeof F.l1_decay_mul!=="undefined"?F.l1_decay_mul:1;var l=this.l2_decay*v;var m=this.l1_decay*G;var s=t.length;for(var z=0;z<s;z++){k+=l*t[z]*t[z]/2;d+=m*Math.abs(t[z]);var A=m*(t[z]>0?1:-1);var n=l*(t[z]);if(this.momentum>0){var u=-this.learning_rate*(n+A+C[z])/this.batch_size;var D=this.momentum*this.last_gs[B][z]+(1-this.momentum)*u;t[z]+=D;this.last_gs[B][z]=D}else{t[z]-=this.learning_rate*(n+A+C[z])/this.batch_size}C[z]=0}}}return{fwd_time:o,bwd_time:E,l2_decay_loss:k,l1_decay_loss:d,cost_loss:w,softmax_loss:w,loss:w+d+k}}};c.SGDTrainer=b})(convnetjs);(function(a){if(typeof module==="undefined"||typeof module.exports==="undefined"){window.jsfeat=a}else{module.exports=a}})(convnetjs);